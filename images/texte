
---------- ÉTAPE 6 – STAGING (DONNÉES EXPLOITABLES)
--------- Données cohérentes, standardisées, jointables

CREATE TABLE stg_client AS
SELECT DISTINCT
    client_id,
    UPPER(TRIM(secteur)) AS secteur,
    pays,
    date_creation
FROM src_client
WHERE pays IS NOT NULL
AND secteur IS NOT NULL;


CREATE TABLE stg_facture AS
SELECT f.*
FROM src_facture f
JOIN stg_client c ON f.client_id = c.client_id
WHERE f.montant_ht > 0
AND f.montant_ht <= 100000
AND f.date_facture <= CURDATE();

CREATE TABLE stg_paiement AS
SELECT p.*
FROM src_paiement p
JOIN stg_facture f ON p.facture_id = f.facture_id
WHERE p.montant_paye <= f.montant_ht;

------- CONTRÔLE POST-STAGING (PARITÉ FONCTIONNELLE)
----------- src = stg + rejets

SELECT COUNT(*) FROM src_facture;
SELECT COUNT(*) FROM stg_facture;
SELECT COUNT(*) FROM dq_rejets_facture;

---------- ÉTAPE 7 – DATA WAREHOUSE (SCHÉMA ÉTOILE)
----------- Dimension Client
CREATE TABLE dim_client (
    client_sk INT AUTO_INCREMENT PRIMARY KEY,
    client_id INT,
    secteur VARCHAR(50),
    pays VARCHAR(10)
);

INSERT INTO dim_client (client_id, secteur, pays)
SELECT DISTINCT client_id, secteur, pays
FROM stg_client;

------- Dimension Temps
CREATE TABLE dim_date (
    date_sk INT PRIMARY KEY,
    date DATE,
    annee INT,
    mois INT
);

INSERT INTO dim_date
SELECT DISTINCT
    DATE_FORMAT(date_facture, '%Y%m%d') AS date_sk,
    date_facture,
    YEAR(date_facture),
    MONTH(date_facture)
FROM stg_facture;

-------- Fait Facture
CREATE TABLE fact_facture (
    client_sk INT,
    date_sk INT,
    montant_ht DECIMAL(15,2)
);

INSERT INTO fact_facture
SELECT
    c.client_sk,
    d.date_sk,
    f.montant_ht
FROM stg_facture f
JOIN dim_client c ON f.client_id = c.client_id
JOIN dim_date d ON f.date_facture = d.date;


select * from  dim_client;
select * from  dim_date;
select * from  fact_facture;


















